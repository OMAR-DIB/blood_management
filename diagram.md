# Blood Bank System - Visual Diagrams & Flowcharts

## ğŸ“Š 1. System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER LAYER                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Donor   â”‚    â”‚ Hospital â”‚    â”‚  Admin   â”‚              â”‚
â”‚  â”‚  ğŸ©¸      â”‚    â”‚    ğŸ¥    â”‚    â”‚   ğŸ‘¨â€ğŸ’¼   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND LAYER                           â”‚
â”‚                   (React/Vue/etc)                           â”‚
â”‚                                                              â”‚
â”‚   - Login Forms         - Blood Request Forms               â”‚
â”‚   - Donor Dashboards   - Inventory Views                    â”‚
â”‚   - Admin Panel        - Reports & Analytics                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP Requests (JSON)
                         â”‚ + JWT Token in Headers
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND LAYER (Node.js + Express)        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              server.js (Entry Point)                  â”‚  â”‚
â”‚  â”‚  - CORS Setup                                         â”‚  â”‚
â”‚  â”‚  - JSON Parser                                        â”‚  â”‚
â”‚  â”‚  - Route Registration                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           MIDDLEWARE LAYER (Security)                â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚  â”‚   auth   â”‚ â†’  â”‚ roleCheckâ”‚ â†’ â”‚ Business â”‚       â”‚  â”‚
â”‚  â”‚  â”‚  (JWT)   â”‚    â”‚ (Perms)  â”‚   â”‚  Logic   â”‚       â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ROUTES (URL Mapping)                     â”‚  â”‚
â”‚  â”‚  /api/auth/*     - Authentication                     â”‚  â”‚
â”‚  â”‚  /api/donors/*   - Donor Management                   â”‚  â”‚
â”‚  â”‚  /api/requests/* - Blood Requests                     â”‚  â”‚
â”‚  â”‚  /api/admin/*    - Admin Functions                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           CONTROLLERS (Business Logic)               â”‚  â”‚
â”‚  â”‚  - Validate Input                                     â”‚  â”‚
â”‚  â”‚  - Process Data                                       â”‚  â”‚
â”‚  â”‚  - Call Models                                        â”‚  â”‚
â”‚  â”‚  - Return Responses                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              MODELS (Data Layer)                      â”‚  â”‚
â”‚  â”‚  - BloodRequest Model                                 â”‚  â”‚
â”‚  â”‚  - Donor Model                                        â”‚  â”‚
â”‚  â”‚  - Inventory Model                                    â”‚  â”‚
â”‚  â”‚  - User Model                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ SQL Queries
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DATABASE LAYER (MySQL)                    â”‚
â”‚                                                              â”‚
â”‚  Tables:                     Views:                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ users           â”‚        â”‚ inventory_       â”‚           â”‚
â”‚  â”‚ blood_inventory â”‚        â”‚ expiring_soon    â”‚           â”‚
â”‚  â”‚ blood_requests  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”‚ donors          â”‚                                        â”‚
â”‚  â”‚ donations       â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” 2. Authentication Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚
â”‚ (Browser)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 1. POST /api/auth/login
     â”‚    { email: "user@example.com", password: "12345" }
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BACKEND: authController.js           â”‚
â”‚                                              â”‚
â”‚  Step 1: Receive login request               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ const { email, password } = req.body â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                   â”‚
â”‚           â–¼                                   â”‚
â”‚  Step 2: Query database for user             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SELECT * FROM users                  â”‚   â”‚
â”‚  â”‚ WHERE email = ?                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                   â”‚
â”‚           â–¼                                   â”‚
â”‚  Step 3: Check if user exists                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ if (users.length === 0)              â”‚   â”‚
â”‚  â”‚   return 404 "User not found"        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                   â”‚
â”‚           â–¼                                   â”‚
â”‚  Step 4: Verify password                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ const isMatch = await bcrypt.compare â”‚   â”‚
â”‚  â”‚   (password, user.password)          â”‚   â”‚
â”‚  â”‚ if (!isMatch)                        â”‚   â”‚
â”‚  â”‚   return 401 "Invalid credentials"   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                   â”‚
â”‚           â–¼                                   â”‚
â”‚  Step 5: Check if account is active          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ if (!user.is_active)                 â”‚   â”‚
â”‚  â”‚   return 401 "Account deactivated"   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                   â”‚
â”‚           â–¼                                   â”‚
â”‚  Step 6: Generate JWT Token                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ const token = jwt.sign(              â”‚   â”‚
â”‚  â”‚   { userId: user.user_id },          â”‚   â”‚
â”‚  â”‚   JWT_SECRET,                        â”‚   â”‚
â”‚  â”‚   { expiresIn: '7d' }                â”‚   â”‚
â”‚  â”‚ )                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                   â”‚
â”‚           â–¼                                   â”‚
â”‚  Step 7: Return token to user                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ return {                             â”‚   â”‚
â”‚  â”‚   success: true,                     â”‚   â”‚
â”‚  â”‚   token: "eyJhbGciOiJIUz...",        â”‚   â”‚
â”‚  â”‚   user: { id, name, role }           â”‚   â”‚
â”‚  â”‚ }                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User stores token                â”‚
â”‚  (in localStorage or cookie)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ 2. Every subsequent request includes token
               â”‚
               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Authorization: Bearer   â”‚
     â”‚ eyJhbGciOiJIUz...       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ©¸ 3. Blood Request Creation Flow

```
                    CREATE BLOOD REQUEST FLOW

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hospital   â”‚ 1. Fills out blood request form
â”‚  User       â”‚    - Patient name: John Doe
â”‚   ğŸ¥        â”‚    - Blood type: A+
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    - Units: 2
       â”‚           - Urgency: High
       â”‚
       â”‚ 2. Submits form
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/requests                                        â”‚
â”‚  Headers: { Authorization: Bearer eyJhbGc... }             â”‚
â”‚  Body: {                                                   â”‚
â”‚    patient_name: "John Doe",                               â”‚
â”‚    blood_group: "A+",                                      â”‚
â”‚    units_required: 2,                                      â”‚
â”‚    urgency: "High",                                        â”‚
â”‚    ...                                                     â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE: auth (Authentication Check)                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1. Extract token from header                       â”‚    â”‚
â”‚  â”‚    const token = req.header('Authorization')       â”‚    â”‚
â”‚  â”‚                    .replace('Bearer ', '')         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ 2. Verify token                                    â”‚    â”‚
â”‚  â”‚    const decoded = jwt.verify(token, JWT_SECRET)   â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ 3. Get user from database                          â”‚    â”‚
â”‚  â”‚    SELECT * FROM users WHERE user_id = ?           â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ 4. Check if user is active                         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ 5. Attach user to request object                   â”‚    â”‚
â”‚  â”‚    req.user = user                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚    âœ… Token Valid â†’ Continue                                â”‚
â”‚    âŒ Token Invalid â†’ Return 401 Unauthorized               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE: checkRole (Authorization Check)                â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1. Check if user exists (from auth middleware)    â”‚    â”‚
â”‚  â”‚    if (!req.user) â†’ 401 Unauthorized              â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ 2. Check user's role                               â”‚    â”‚
â”‚  â”‚    if (req.user.role !== 'hospital')              â”‚    â”‚
â”‚  â”‚       â†’ 403 Forbidden                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚    âœ… User is Hospital â†’ Continue                           â”‚
â”‚    âŒ User is not Hospital â†’ Return 403 Forbidden           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER: createRequest                                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Step 1: Extract data from request body            â”‚    â”‚
â”‚  â”‚ const { patient_name, blood_group, ... } = req.bodyâ”‚   â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ Step 2: Validate required fields                   â”‚    â”‚
â”‚  â”‚ if (!patient_name || !blood_group || ...)          â”‚    â”‚
â”‚  â”‚    return 400 "Missing required fields"            â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ Step 3: Validate data types and formats            â”‚    â”‚
â”‚  â”‚ if (units_required < 1 || units_required > 10)     â”‚    â”‚
â”‚  â”‚    return 400 "Invalid units"                      â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ Step 4: Insert into database                       â”‚    â”‚
â”‚  â”‚ INSERT INTO blood_requests                         â”‚    â”‚
â”‚  â”‚ (hospital_id, patient_name, blood_group, ...)      â”‚    â”‚
â”‚  â”‚ VALUES (?, ?, ?, ...)                              â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ Step 5: Get the new request ID                     â”‚    â”‚
â”‚  â”‚ const request_id = result.insertId                 â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ Step 6: Return success response                    â”‚    â”‚
â”‚  â”‚ return {                                           â”‚    â”‚
â”‚  â”‚   success: true,                                   â”‚    â”‚
â”‚  â”‚   message: "Request created",                      â”‚    â”‚
â”‚  â”‚   request_id: 789                                  â”‚    â”‚
â”‚  â”‚ }                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: blood_requests table                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ req_id â”‚hospital_idâ”‚patient â”‚blood_grp â”‚ units    â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ 789    â”‚ 123      â”‚John Doeâ”‚   A+     â”‚    2     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         âœ… NEW RECORD SAVED                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response sent back to frontend                             â”‚
â”‚  {                                                           â”‚
â”‚    success: true,                                            â”‚
â”‚    message: "Blood request created successfully",            â”‚
â”‚    request_id: 789                                           â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend shows         â”‚
â”‚  success message:       â”‚
â”‚  "Request submitted!" âœ… â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ 4. Middleware Chain Visualization

```
         REQUEST COMES IN
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   server.js     â”‚  Entry point
    â”‚                 â”‚
    â”‚ app.use(cors()) â”‚  Enable CORS
    â”‚ app.use(json()) â”‚  Parse JSON
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Route Matching         â”‚
    â”‚  /api/requests          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MIDDLEWARE #1: auth    â”‚ â† Security Checkpoint 1
    â”‚                         â”‚
    â”‚  âœ“ Check token exists   â”‚
    â”‚  âœ“ Verify token valid   â”‚
    â”‚  âœ“ Get user from DB     â”‚
    â”‚  âœ“ Check user active    â”‚
    â”‚  âœ“ Attach user to req   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ req.user = { id: 123, role: 'hospital', ... }
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MIDDLEWARE #2:          â”‚ â† Security Checkpoint 2
    â”‚ checkRole('hospital')   â”‚
    â”‚                         â”‚
    â”‚  âœ“ Check req.user existsâ”‚
    â”‚  âœ“ Check role = hospitalâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CONTROLLER FUNCTION    â”‚ â† Business Logic
    â”‚  createRequest()        â”‚
    â”‚                         â”‚
    â”‚  âœ“ Validate input       â”‚
    â”‚  âœ“ Process data         â”‚
    â”‚  âœ“ Save to DB           â”‚
    â”‚  âœ“ Return response      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
         RESPONSE SENT
         TO CLIENT


If any middleware fails:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth fails             â”‚
â”‚  â†“                      â”‚
â”‚  Return 401 immediately â”‚
â”‚  STOP - Don't continue  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š 5. Database View Logic: inventory_expiring_soon

```
                    HOW THE VIEW WORKS

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TABLE: blood_inventory                                  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ID  â”‚ Blood  â”‚ Volume  â”‚ Donation â”‚Expiry  â”‚Statusâ”‚ â”‚
â”‚  â”‚     â”‚ Group  â”‚  (ml)   â”‚   Date   â”‚ Date   â”‚      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 101 â”‚  A+    â”‚  450    â”‚2025-10-01â”‚2025-11-15â”‚Availâ”‚ â”‚
â”‚  â”‚ 102 â”‚  O-    â”‚  450    â”‚2025-10-20â”‚2025-10-30â”‚Availâ”‚ â”‚ â† Expires in 3 days!
â”‚  â”‚ 103 â”‚  B+    â”‚  450    â”‚2025-09-15â”‚2025-10-28â”‚Availâ”‚ â”‚ â† Expires in 1 day!
â”‚  â”‚ 104 â”‚  AB-   â”‚  450    â”‚2025-10-25â”‚2025-12-01â”‚Availâ”‚ â”‚
â”‚  â”‚ 105 â”‚  A-    â”‚  450    â”‚2025-08-10â”‚2025-10-15â”‚Used â”‚ â”‚ â† Already used
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ VIEW FILTERS:
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Filter Conditions:  â”‚
            â”‚                      â”‚
            â”‚  1. status='Available'
            â”‚     (exclude Used)   â”‚
            â”‚                      â”‚
            â”‚  2. expiration_date  â”‚
            â”‚     <= today + 7 daysâ”‚
            â”‚     (expires soon)   â”‚
            â”‚                      â”‚
            â”‚  3. expiration_date  â”‚
            â”‚     >= today         â”‚
            â”‚     (not expired yet)â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VIEW: inventory_expiring_soon                           â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ID  â”‚ Blood  â”‚ Volume  â”‚ Expiry   â”‚Status  â”‚ Days  â”‚ â”‚
â”‚  â”‚     â”‚ Group  â”‚  (ml)   â”‚ Date     â”‚        â”‚ Left  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 103 â”‚  B+    â”‚  450    â”‚2025-10-28â”‚Availableâ”‚  1   â”‚ â”‚ â† Most urgent!
â”‚  â”‚ 102 â”‚  O-    â”‚  450    â”‚2025-10-30â”‚Availableâ”‚  3   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚  Sorted by: expiration_date ASC (oldest first)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Today = 2025-10-27

Decision Tree:
ID 101: Expires 2025-11-15 â†’ 19 days away â†’ NOT included (>7 days)
ID 102: Expires 2025-10-30 â†’ 3 days away  â†’ âœ… INCLUDED
ID 103: Expires 2025-10-28 â†’ 1 day away   â†’ âœ… INCLUDED (most urgent)
ID 104: Expires 2025-12-01 â†’ 35 days away â†’ NOT included (>7 days)
ID 105: Status = 'Used'    â†’ NOT included (not available)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BUSINESS USE CASE                                       â”‚
â”‚                                                           â”‚
â”‚  Hospital Dashboard:                                     â”‚
â”‚  "âš ï¸ 2 blood units expiring soon!"                       â”‚
â”‚                                                           â”‚
â”‚  Alert Notification:                                     â”‚
â”‚  "B+ blood expires in 1 day - use urgently!"            â”‚
â”‚                                                           â”‚
â”‚  Automated Actions:                                      â”‚
â”‚  - Email hospitals with urgent requests for B+ blood    â”‚
â”‚  - Prioritize matching with pending B+ requests          â”‚
â”‚  - Mark as "critical" in inventory system                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ 6. Update Request Flow with Ownership Check

```
                UPDATE BLOOD REQUEST FLOW

Hospital User (ID: 123) wants to update request (ID: 789)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PUT /api/requests/789                             â”‚
â”‚  Headers: { Authorization: Bearer token... }       â”‚
â”‚  Body: {                                           â”‚
â”‚    patient_name: "Jane Doe",  â† Update this       â”‚
â”‚    units_required: 3          â† Update this       â”‚
â”‚  }                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE: auth                                    â”‚
â”‚  âœ“ Verifies token                                    â”‚
â”‚  âœ“ Sets req.user = { user_id: 123, role: 'hospital' }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER: updateRequest                           â”‚
â”‚                                                       â”‚
â”‚  Step 1: Get request ID from URL                     â”‚
â”‚  const { id } = req.params // 789                    â”‚
â”‚                                                       â”‚
â”‚  Step 2: Get current user info                       â”‚
â”‚  const userId = req.user.user_id // 123              â”‚
â”‚  const userRole = req.user.role   // 'hospital'      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: OWNERSHIP CHECK - Query database            â”‚
â”‚                                                       â”‚
â”‚  SELECT hospital_id FROM blood_requests              â”‚
â”‚  WHERE request_id = 789                              â”‚
â”‚                                                       â”‚
â”‚  Result: { hospital_id: 123 }                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: AUTHORIZATION CHECK                         â”‚
â”‚                                                       â”‚
â”‚  if (request.hospital_id !== userId                  â”‚
â”‚      && userRole !== 'admin') {                      â”‚
â”‚    return 403 Forbidden                              â”‚
â”‚  }                                                   â”‚
â”‚                                                       â”‚
â”‚  Check: Does hospital_id (123) = userId (123)?       â”‚
â”‚  âœ… YES â†’ User owns this request                     â”‚
â”‚  OR                                                   â”‚
â”‚  Is userRole = 'admin'?                              â”‚
â”‚  â†’ Admin can edit any request                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: DYNAMIC UPDATE BUILDER                      â”‚
â”‚                                                       â”‚
â”‚  updates = []                                        â”‚
â”‚  params = []                                         â”‚
â”‚                                                       â”‚
â”‚  IF patient_name provided:                           â”‚
â”‚    updates.push('patient_name = ?')                  â”‚
â”‚    params.push('Jane Doe')                           â”‚
â”‚                                                       â”‚
â”‚  IF units_required provided:                         â”‚
â”‚    updates.push('units_required = ?')                â”‚
â”‚    params.push(3)                                    â”‚
â”‚                                                       â”‚
â”‚  Final SQL:                                          â”‚
â”‚  UPDATE blood_requests                               â”‚
â”‚  SET patient_name = ?, units_required = ?            â”‚
â”‚  WHERE request_id = ?                                â”‚
â”‚  VALUES: ['Jane Doe', 3, 789]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE UPDATE                                     â”‚
â”‚                                                       â”‚
â”‚  BEFORE:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚req_id  â”‚hospital_idâ”‚patient â”‚units â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ 789    â”‚ 123      â”‚John Doeâ”‚  2   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                       â”‚
â”‚  AFTER:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚req_id  â”‚hospital_idâ”‚patient â”‚units â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ 789    â”‚ 123      â”‚Jane Doeâ”‚  3   â”‚ â† Updated!  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response: { success: true, message: "Updated" }     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SECURITY SCENARIOS:

Scenario 1: Hospital tries to edit their own request
User ID: 123, Request hospital_id: 123
âœ… ALLOWED - Ownership match

Scenario 2: Hospital tries to edit another hospital's request
User ID: 123, Request hospital_id: 456
âŒ FORBIDDEN - No ownership

Scenario 3: Admin edits any request
User Role: 'admin', Request hospital_id: 456
âœ… ALLOWED - Admin privilege

Scenario 4: Request doesn't exist
Request ID: 999 (not in database)
âŒ NOT FOUND - 404 error
```

---

## ğŸ­ 7. Role-Based Access Control Matrix

```
                PERMISSION MATRIX

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Action        â”‚  Admin  â”‚ Hospital â”‚  Donor  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ View all users     â”‚    âœ…   â”‚    âŒ    â”‚    âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Create blood       â”‚    âŒ   â”‚    âœ…    â”‚    âŒ   â”‚
â”‚ request            â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ View own           â”‚    âœ…   â”‚    âœ…    â”‚    âŒ   â”‚
â”‚ requests           â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Update own         â”‚    âœ…   â”‚    âœ…    â”‚    âŒ   â”‚
â”‚ request            â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Update ANY         â”‚    âœ…   â”‚    âŒ    â”‚    âŒ   â”‚
â”‚ request            â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Delete own         â”‚    âœ…   â”‚    âœ…    â”‚    âŒ   â”‚
â”‚ request            â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Delete ANY         â”‚    âœ…   â”‚    âŒ    â”‚    âŒ   â”‚
â”‚ request            â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Register as        â”‚    âœ…   â”‚    âŒ    â”‚    âœ…   â”‚
â”‚ donor              â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ View donor         â”‚    âœ…   â”‚    âœ…    â”‚    âœ…   â”‚
â”‚ list (public)      â”‚         â”‚          â”‚    (own)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ View expiring      â”‚    âœ…   â”‚    âœ…    â”‚    âŒ   â”‚
â”‚ inventory          â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Manage             â”‚    âœ…   â”‚    âŒ    â”‚    âŒ   â”‚
â”‚ inventory          â”‚         â”‚          â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Deactivate         â”‚    âœ…   â”‚    âŒ    â”‚    âŒ   â”‚
â”‚ users              â”‚         â”‚          â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
âœ… = Allowed
âŒ = Denied (403 Forbidden)
```

---

## ğŸ”’ 8. JWT Token Structure

```
            JWT TOKEN ANATOMY

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Complete Token (sent in Authorization header) â”‚
â”‚                                                  â”‚
â”‚  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.          â”‚
â”‚  eyJ1c2VySWQiOjEyMywidXNlcm5hbWUiOiJob3NwaX      â”‚
â”‚  RhbDEyMyIsInJvbGUiOiJob3NwaXRhbCIsImlhdCI6MT      â”‚
â”‚  Y5ODc2NTQzMiwiZXhwIjoxNjk5MzcwMDMyfQ.          â”‚
â”‚  SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚           â”‚              â”‚
              â”‚           â”‚              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”˜           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                  â”‚                       â”‚
       â–¼                  â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HEADER    â”‚   â”‚    PAYLOAD      â”‚   â”‚  SIGNATURE   â”‚
â”‚            â”‚   â”‚                 â”‚   â”‚              â”‚
â”‚ Algorithm: â”‚   â”‚ userId: 123     â”‚   â”‚ Encrypted    â”‚
â”‚ HS256      â”‚   â”‚ role: hospital  â”‚   â”‚ signature to â”‚
â”‚            â”‚   â”‚ iat: 1698765432 â”‚   â”‚ verify token â”‚
â”‚ Type: JWT  â”‚   â”‚ exp: 1699370032 â”‚   â”‚ is not fake  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ DECODES TO:
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ {                   â”‚
                 â”‚   userId: 123,      â”‚
                 â”‚   username: "...",  â”‚
                 â”‚   role: "hospital", â”‚
                 â”‚   iat: 1698765432,  â”‚ â† Issued at
                 â”‚   exp: 1699370032   â”‚ â† Expires at
                 â”‚ }                   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HOW IT'S USED:

1. Login â†’ Server creates token
   â†“
2. Client stores token (localStorage)
   â†“
3. Every request includes token in header:
   Authorization: Bearer eyJhbGci...
   â†“
4. Server verifies signature
   â†“
5. If valid â†’ Decode and use payload data
   If invalid â†’ Return 401 Unauthorized


WHY JWT?

âœ… Stateless - Server doesn't store sessions
âœ… Self-contained - All info is in the token
âœ… Secure - Signature prevents tampering
âœ… Scalable - Works across multiple servers
```

---

## ğŸ“± 9. Complete API Endpoints Map

```
                    API ROUTES STRUCTURE

ğŸ“ /api
â”‚
â”œâ”€ ğŸ” /auth (Authentication)
â”‚   â”œâ”€ POST /register         â†’ Register new user
â”‚   â”œâ”€ POST /login            â†’ Login and get token
â”‚   â”œâ”€ GET  /profile          â†’ Get current user profile (needs auth)
â”‚   â””â”€ PUT  /profile          â†’ Update profile (needs auth)
â”‚
â”œâ”€ ğŸ©¸ /donors (Donor Management)
â”‚   â”œâ”€ GET  /                 â†’ List all donors (public)
â”‚   â”œâ”€ GET  /:id              â†’ Get specific donor
â”‚   â”œâ”€ POST /                 â†’ Register as donor (needs auth: donor)
â”‚   â”œâ”€ PUT  /:id              â†’ Update donor info (needs auth: owner/admin)
â”‚   â””â”€ DELETE /:id            â†’ Delete donor (needs auth: owner/admin)
â”‚
â”œâ”€ ğŸ¥ /requests (Blood Requests)
â”‚   â”œâ”€ GET  /                 â†’ List all requests
â”‚   â”œâ”€ GET  /my-requests      â†’ Get my requests (needs auth)
â”‚   â”œâ”€ GET  /:id              â†’ Get specific request
â”‚   â”œâ”€ POST /                 â†’ Create request (needs auth: hospital)
â”‚   â”œâ”€ PUT  /:id              â†’ Update request (needs auth: owner/admin)
â”‚   â””â”€ DELETE /:id            â†’ Delete request (needs auth: owner/admin)
â”‚
â””â”€ ğŸ‘¨â€ğŸ’¼ /admin (Admin Functions)
    â”œâ”€ GET  /users            â†’ List all users (needs auth: admin)
    â”œâ”€ GET  /users/:id        â†’ Get specific user (needs auth: admin)
    â”œâ”€ PUT  /users/:id        â†’ Update user (needs auth: admin)
    â”œâ”€ DELETE /users/:id      â†’ Delete user (needs auth: admin)
    â”œâ”€ GET  /inventory        â†’ View blood inventory (needs auth: admin)
    â”œâ”€ GET  /expiring         â†’ View expiring inventory (needs auth: admin)
    â”œâ”€ GET  /stats            â†’ Get system statistics (needs auth: admin)
    â””â”€ POST /inventory        â†’ Add blood unit (needs auth: admin)


MIDDLEWARE APPLIED:

Route Pattern             â”‚ Middleware Chain
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/auth/register, /login   â”‚ No auth required (public)
/auth/profile            â”‚ auth
/donors (GET all)        â”‚ No auth (public viewing)
/donors (POST)           â”‚ auth + isDonor
/donors/:id (PUT/DELETE) â”‚ auth + isOwnerOrAdmin
/requests (GET all)      â”‚ No auth (public viewing)
/requests (POST)         â”‚ auth + isHospital
/requests/:id (PUT/DEL)  â”‚ auth + owner check
/admin/*                 â”‚ auth + isAdmin
```

---

## âš¡ 10. Error Handling Flow

```
                ERROR HANDLING HIERARCHY

Request enters system
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Try-Catch Block     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Success? â”€â”€â†’ Return 200 OK with data
       â”‚
       â”œâ”€ Validation Error? â”€â”€â†’ Return 400 Bad Request
       â”‚   Examples:
       â”‚   â€¢ Missing required fields
       â”‚   â€¢ Invalid data format
       â”‚   â€¢ Out of range values
       â”‚
       â”œâ”€ Authentication Error? â”€â”€â†’ Return 401 Unauthorized
       â”‚   Examples:
       â”‚   â€¢ No token provided
       â”‚   â€¢ Invalid token
       â”‚   â€¢ Expired token
       â”‚   â€¢ Inactive user account
       â”‚
       â”œâ”€ Authorization Error? â”€â”€â†’ Return 403 Forbidden
       â”‚   Examples:
       â”‚   â€¢ Wrong role (donor trying hospital action)
       â”‚   â€¢ Not owner of resource
       â”‚   â€¢ Missing permissions
       â”‚
       â”œâ”€ Not Found Error? â”€â”€â†’ Return 404 Not Found
       â”‚   Examples:
       â”‚   â€¢ Request ID doesn't exist
       â”‚   â€¢ User not found
       â”‚   â€¢ Resource deleted
       â”‚
       â””â”€ Server Error? â”€â”€â†’ Return 500 Internal Server Error
           Examples:
           â€¢ Database connection failed
           â€¢ Unexpected exception
           â€¢ Third-party service down


ERROR RESPONSE FORMAT:

{
  "success": false,
  "message": "Human-readable error description",
  "error": {
    "code": "ERROR_CODE",
    "details": "Technical details (dev mode only)"
  }
}


EXAMPLE ERROR RESPONSES:

âŒ 400 Bad Request:
{
  "success": false,
  "message": "Blood group is required"
}

âŒ 401 Unauthorized:
{
  "success": false,
  "message": "Invalid token. Please login again."
}

âŒ 403 Forbidden:
{
  "success": false,
  "message": "Access denied. Hospital access required",
  "requiredRoles": ["hospital"],
  "yourRole": "donor"
}

âŒ 404 Not Found:
{
  "success": false,
  "message": "Blood request not found"
}

âŒ 500 Internal Server Error:
{
  "success": false,
  "message": "Failed to create blood request",
  "error": "Database connection timeout"
}
```

---

## ğŸ¯ Summary: Key Takeaways

1. **Layered Architecture**: Requests flow through multiple layers (auth â†’ authorization â†’ business logic â†’ database)

2. **Security First**: Every protected route checks both authentication (who you are) and authorization (what you can do)

3. **Separation of Concerns**: Routes, middleware, controllers, and models each have a specific job

4. **Dynamic Queries**: Update functions only modify fields that are provided

5. **Error Handling**: Comprehensive error responses guide users and developers

6. **Role-Based Access**: Different user types have different permissions

7. **Database Views**: Smart filters that act like saved searches

8. **JWT Tokens**: Stateless authentication that scales well

9. **RESTful Design**: Standard HTTP methods for predictable API behavior

10. **Real-World Application**: Solves actual blood bank management challenges

---

This visual guide should help you explain the system architecture and data flow to your student in a clear, step-by-step manner!
